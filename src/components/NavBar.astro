---
import { Image } from "astro:assets";
import logo from "../assets/images/logo.svg";

// Get base URL for GitHub Pages support
const base = import.meta.env.BASE_URL;
---

<nav
  class="navbar is-fixed-top p-3"
  role="navigation"
  aria-label="main navigation"
>
  <div class="container is-fluid">
    <div class="navbar-brand">
      <a class="navbar-item pl-0" href={base}>
        <Image src={logo} alt="firmpage logo" />
      </a>

      <!-- Mobile burger -->
      <a
        role="button"
        class="navbar-burger is-hidden-desktop"
        aria-label="menu"
        aria-expanded="false"
        data-target="mainNav"
      >
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>

      <!-- Desktop burger -->
      <button
        class="desktop-burger is-hidden-touch"
        aria-label="menu"
        data-desktop-burger
      >
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </button>
    </div>

    <div id="mainNav" class="navbar-menu">
      <div class="navbar-start"></div>
      <div class="navbar-end">
        <a
          class="navbar-item"
          href={`${base}/how-it-works`}
          aria-current={Astro.url.pathname === `${base}/how-it-works`
            ? "page"
            : undefined}
        >
          How It Works
        </a>
        <a
          class="navbar-item"
          href={`${base}/examples`}
          aria-current={Astro.url.pathname === `${base}/examples` ? "page" : undefined}
        >
          Examples
        </a>
        <a
          class="navbar-item"
          href={`${base}/pricing`}
          aria-current={Astro.url.pathname === `${base}/pricing` ? "page" : undefined}
        >
          Pricing
        </a>
        <div class="navbar-item">
          <div class="buttons">
            <a class="button is-primary is-outlined"> Log in </a>
            <a class="button is-warning" href={`${base}/demo`}> Get A Demo </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>

<style lang="scss">
  .navbar {
    --collapsed-width: 312px;
    --container-padding: 1.5rem;
    --bulma-navbar-item-img-max-height: 100%;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    width: 100%;
    box-shadow: 0 0 0 rgba(0, 0, 0, 0);

    &.has-shadow {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      background: rgba(255, 255, 255, 0.7);
    }

    .nav-container {
      margin: 0 auto;
      position: relative;
      max-width: 100%;
      width: 100%;
      padding: 0 var(--container-padding);
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
    }

    .navbar-menu {
      opacity: 1;
      transform: translateX(0);
      transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: auto;
      flex: 1;
      position: relative;

      // Mobile menu styling
      @media screen and (max-width: 1023px) {
        display: none;

        &.is-active {
          display: block;
          position: absolute;
          left: 0;
          right: 0;
          top: 100%;
          background: rgba(255, 255, 255, 1);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
          box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
          padding: 1rem;
          z-index: 30;
        }
      }
    }

    .navbar-brand {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: auto;

      @media screen and (max-width: 1023px) {
        width: 100%;
      }

      .navbar-item {
        padding-left: 0;
        &:hover {
          background-color: transparent !important;
        }

        &::after {
          display: none; // Remove underline from logo
        }
      }
    }

    .navbar-item {
      background-color: transparent !important;
      position: relative;

      &:not(:has(.buttons))::after {
        content: "";
        position: absolute;
        width: 100%;
        height: 2px;
        bottom: calc(50% - 20px);
        left: 0;
        background-color: var(--bulma-primary);
        transform: scaleX(0);
        transform-origin: right;
        transition: transform 0.3s ease;
      }

      &:not(:has(.buttons)):hover::after,
      &:not(:has(.buttons))[aria-current="page"]::after {
        transform: scaleX(1);
        transform-origin: left;
      }
    }

    &.is-collapsed {
      width: var(--collapsed-width);
      padding: 0.5rem !important;

      .container {
        padding: 0 1rem;
      }

      .navbar-menu {
        opacity: 0;
        transform: translateX(30px);
        pointer-events: none;
        position: absolute;
        right: 0;
        top: 0;
        height: 100%;
        display: flex;
        align-items: center;
      }

      .desktop-burger {
        opacity: 1;
        pointer-events: auto;
      }

      .navbar-brand {
        flex: 1;
        width: 100%;
      }
    }

    // Added mobile burger styling
    .navbar-burger {
      margin-left: auto;
      color: currentColor;
    }
  }

  .desktop-burger {
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    height: 3.25rem;
    justify-content: center;
    padding: 0;
    position: relative;
    min-width: 3.25rem;
    width: 3.25rem;
    opacity: 0;
    pointer-events: none;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    margin: 0;

    span {
      background-color: currentColor;
      display: block;
      height: 1px;
      left: calc(50% - 8px);
      position: absolute;
      transform-origin: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      width: 16px;

      &:nth-child(1) {
        top: calc(50% - 6px);
      }
      &:nth-child(2) {
        top: calc(50%);
      }
      &:nth-child(3) {
        top: calc(50% + 6px);
      }
    }

    &.is-active {
      span {
        &:nth-child(1) {
          transform: translateY(5px) rotate(45deg);
        }
        &:nth-child(2) {
          opacity: 0;
        }
        &:nth-child(3) {
          transform: translateY(-5px) rotate(-45deg);
        }
      }
    }
  }
</style>

<script>
  const navbar = document.querySelector(".navbar");
  const desktopBurger = document.querySelector("[data-desktop-burger]");
  const mobileBurger = document.querySelector(".navbar-burger");
  const SCROLL_THRESHOLD = 100;
  const SHADOW_THRESHOLD = 20;

  function updateNavShadow() {
    if (window.scrollY > SHADOW_THRESHOLD) {
      navbar?.classList.add("has-shadow");
    } else {
      navbar?.classList.remove("has-shadow");
    }
  }

  function collapseNav() {
    navbar?.classList.add("is-collapsed");
    desktopBurger?.classList.remove("is-active");
  }

  function expandNav() {
    navbar?.classList.remove("is-collapsed");
    desktopBurger?.classList.remove("is-active");
  }

  function handleScroll() {
    updateNavShadow();
    if (window.innerWidth >= 1024) {
      if (window.scrollY > SCROLL_THRESHOLD) {
        collapseNav();
      } else {
        expandNav();
      }
    }
  }

  // Split scroll handlers for better performance
  let collapseTimeout: number;
  window.addEventListener("scroll", () => {
    // Update shadow immediately
    updateNavShadow();

    // Debounce the collapse/expand
    if (collapseTimeout) {
      clearTimeout(collapseTimeout);
    }
    collapseTimeout = setTimeout(() => {
      if (window.innerWidth >= 1024) {
        if (window.scrollY > SCROLL_THRESHOLD) {
          collapseNav();
        } else {
          expandNav();
        }
      }
    }, 10);
  });

  // Handle mobile burger click
  mobileBurger?.addEventListener("click", () => {
    const targetId = mobileBurger.getAttribute("data-target");
    const targetMenu = document.getElementById(targetId || "");

    // Toggle is-active class on burger
    mobileBurger.classList.toggle("is-active");

    // Toggle is-active class on menu
    targetMenu?.classList.toggle("is-active");
  });

  // Handle desktop burger click
  desktopBurger?.addEventListener("click", (e) => {
    e.stopPropagation();
    if (navbar?.classList.contains("is-collapsed")) {
      navbar.classList.remove("is-collapsed");
      desktopBurger.classList.add("is-active");
    } else {
      collapseNav();
    }
  });

  // Handle window resize
  window.addEventListener("resize", () => {
    if (window.innerWidth < 1024) {
      expandNav();
    } else {
      handleScroll();
    }
  });

  // Reset burger when clicking outside
  document.addEventListener("click", (e) => {
    if (
      navbar?.classList.contains("is-collapsed") === false && // Only if nav is expanded
      !navbar?.contains(e.target as Node) && // Click is outside navbar
      window.scrollY > SCROLL_THRESHOLD && // Past scroll threshold
      window.innerWidth >= 1024 // Only on desktop
    ) {
      collapseNav();
    }
  });
</script>
