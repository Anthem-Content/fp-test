---
// This component activates CMS preview mode when ?cms-preview=true query parameter is present
// It enables live content updates and bidirectional communication with the CMS editor
---

<script is:inline>
  // Only activate preview mode if query parameter is present
  const urlParams = new URLSearchParams(window.location.search);
  const isPreviewMode = urlParams.get('cms-preview') === 'true';

  if (isPreviewMode) {
    console.log('[CMS Preview] Preview mode activated');

    // Listen for content updates from CMS
    window.addEventListener('message', (event) => {
      // Security: Verify origin matches CMS domain (production or local dev)
      const allowedOrigins = [
        'https://anthem-content.github.io',
        'http://localhost:5173'
      ];

      if (!allowedOrigins.includes(event.origin)) {
        console.warn('[CMS Preview] Rejected message from unauthorized origin:', event.origin);
        return;
      }

      if (event.data && event.data.type === 'CMS_DATA_UPDATE') {
        console.log('[CMS Preview] Received content update', event.data.data);
        updatePageContent(event.data.data);
      }
    });

    // Function to format text with bracket highlights
    function formatTextWithBrackets(text) {
      if (!text || typeof text !== 'string') return text;

      // Split by brackets and wrap highlighted portions
      return text.replace(/\[([^\]]+)\]/g, '<span class="has-text-primary">$1</span>');
    }

    // Function to update page content dynamically
    function updatePageContent(data) {
      if (!data) return;

      console.log('[CMS Preview] Updating page content with data:', data);

      // Update hero section
      if (data.hero) {
        const heroSection = document.querySelector('[data-cms-section="hero"]');
        console.log('[CMS Preview] Hero section element:', heroSection);

        if (heroSection) {
          // Update h1 title
          const h1 = heroSection.querySelector('h1.title');
          console.log('[CMS Preview] Found h1:', h1, 'New value:', data.hero.title);

          if (h1 && data.hero.title) {
            h1.innerHTML = formatTextWithBrackets(data.hero.title);
            console.log('[CMS Preview] Updated h1 innerHTML to:', h1.innerHTML);
          }

          // Update subtitle if exists
          const subtitle = heroSection.querySelector('.subtitle');
          if (subtitle && data.hero.subtitle) {
            subtitle.textContent = data.hero.subtitle;
          }

          // Update description paragraph
          const description = heroSection.querySelector('p');
          console.log('[CMS Preview] Found description:', description, 'New value:', data.hero.description);

          if (description && data.hero.description) {
            description.textContent = data.hero.description;
            console.log('[CMS Preview] Updated description to:', description.textContent);
          }
        } else {
          console.warn('[CMS Preview] Hero section not found!');
        }
      }

      // Update howItWorks section
      if (data.howItWorks) {
        const section = document.querySelector('[data-cms-section="howItWorks"]');
        if (section) {
          const h2 = section.querySelector('h2.title');
          if (h2 && data.howItWorks.title) {
            h2.innerHTML = formatTextWithBrackets(data.howItWorks.title);
          }

          const subtitle = section.querySelector('.subtitle');
          if (subtitle && data.howItWorks.subtitle) {
            subtitle.textContent = data.howItWorks.subtitle;
          }
        }
      }

      // Update whySection
      if (data.whySection) {
        const section = document.querySelector('[data-cms-section="whySection"]');
        if (section) {
          const h2 = section.querySelector('h2.title');
          if (h2 && data.whySection.title) {
            h2.innerHTML = formatTextWithBrackets(data.whySection.title);
          }

          const subtitle = section.querySelector('.subtitle');
          if (subtitle && data.whySection.subtitle) {
            subtitle.textContent = data.whySection.subtitle;
          }

          const description = section.querySelector('p');
          if (description && data.whySection.description) {
            description.textContent = data.whySection.description;
          }
        }
      }

      // Update features section
      if (data.features) {
        const section = document.querySelector('[data-cms-section="features"]');
        if (section) {
          const h2 = section.querySelector('h2.title');
          if (h2 && data.features.title) {
            h2.innerHTML = formatTextWithBrackets(data.features.title);
          }

          const subtitle = section.querySelector('.subtitle');
          if (subtitle && data.features.subtitle) {
            subtitle.textContent = data.features.subtitle;
          }

          const description = section.querySelectorAll('p')[0]; // Get first p tag for description
          if (description && data.features.description) {
            description.textContent = data.features.description;
          }
        }
      }

      // Update CTA section
      if (data.cta) {
        const section = document.querySelector('[data-cms-section="cta"]');
        if (section) {
          const h2 = section.querySelector('h2.title');
          if (h2 && data.cta.title) {
            h2.innerHTML = formatTextWithBrackets(data.cta.title);
          }

          const button = section.querySelector('a.button');
          if (button && data.cta.buttonText) {
            button.textContent = data.cta.buttonText;
          }

          if (button && data.cta.link) {
            button.href = data.cta.link;
          }
        }
      }

      console.log('[CMS Preview] Page content updated');
    }

    // Add click handlers to sections for editor navigation
    document.addEventListener('DOMContentLoaded', () => {
      const sections = document.querySelectorAll('[data-cms-section]');

      sections.forEach(section => {
        // Add visual indicator when hovering in preview mode
        section.style.cursor = 'pointer';
        section.style.transition = 'outline 0.2s ease';

        section.addEventListener('mouseenter', () => {
          section.style.outline = '2px dashed #00d1b2';
          section.style.outlineOffset = '4px';
        });

        section.addEventListener('mouseleave', () => {
          section.style.outline = 'none';
        });

        section.addEventListener('click', (e) => {
          const sectionName = section.getAttribute('data-cms-section');
          console.log('[CMS Preview] Section clicked:', sectionName);

          // Send message to parent CMS window
          window.parent.postMessage({
            type: 'CMS_SECTION_CLICKED',
            section: sectionName
          }, '*');

          e.stopPropagation();
        });
      });

      // Notify parent that preview is ready
      window.parent.postMessage({
        type: 'CMS_PREVIEW_READY'
      }, '*');
    });

    // Add preview mode indicator
    const indicator = document.createElement('div');
    indicator.style.cssText = `
      position: fixed;
      top: 10px;
      right: 10px;
      background: #00d1b2;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      z-index: 10000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    `;
    indicator.textContent = 'CMS PREVIEW MODE';
    document.body.appendChild(indicator);
  }
</script>
