---
import Layout from "../layouts/Layout.astro";
import Hero from "../components/Hero.astro";
import IconBoxes from "../components/IconBoxes.astro";
import ChecklistSplit from "../components/ChecklistSplit.astro";
import TestimonialScroller from "../components/TestimonialScoller.astro";
import SimpleBoxes from "../components/SimpleBoxes.astro";
import FullCta from "../components/FullCta.astro";
import FeatureIcons from "../components/FeatureIcons.astro";
import MediaSplit from "../components/MediaSplit.astro";
import { getEntry } from "astro:content";

import heroImage from "../assets/images/home/hero.jpg";
import whyImage from "../assets/images/home/why-firm-page.jpg";
import ctaImage from "../assets/images/home/firm-page-cta.jpg";

// Get page content from markdown frontmatter
const pageData = await getEntry("pages", "index");
if (!pageData) {
  throw new Error("Failed to load index page data");
}

// Helper to strip type suffixes from field names (__text, __textarea, __image, __url)
function stripSuffixes(obj: any): any {
  if (!obj || typeof obj !== 'object') return obj;
  if (Array.isArray(obj)) return obj.map(stripSuffixes);

  const cleaned: any = {};
  for (const [key, value] of Object.entries(obj)) {
    const cleanKey = key.replace(/__(text|textarea|image|url)$/, '');
    cleaned[cleanKey] = typeof value === 'object' ? stripSuffixes(value) : value;
  }
  return cleaned;
}

const rawData = pageData.data;
const { hero, howItWorks, whySection, features, cta } = {
  hero: stripSuffixes(rawData.hero),
  howItWorks: stripSuffixes(rawData.howItWorks),
  whySection: stripSuffixes(rawData.whySection),
  features: stripSuffixes(rawData.features),
  cta: stripSuffixes(rawData.cta),
};
---

<Layout>
  <div>
    <Hero
      title={hero.title}
      description={hero.description}
      image={heroImage}
    />
  </div>
  <section class="section">
    <div class="has-background-light">
      <div>
        <IconBoxes
          title={howItWorks.title}
          subtitle={howItWorks.subtitle}
          button={true}
          buttonText={howItWorks.buttonText}
          buttonLink={howItWorks.buttonLink}
          items={howItWorks.items}
        />
      </div>
      <div>
        <MediaSplit
          title={whySection.title}
          subtitle={whySection.subtitle}
          description={whySection.description}
          imageSrc={whyImage}
          imageAlt={whySection.imageAlt}
          mediaOnRight={false}
          showButton={true}
          buttonText={whySection.buttonText}
          buttonUrl={whySection.buttonUrl}
        />

      </div>
    </div>
  </section>
  <section class="section">
    <div class="container">
      <div>
        <FeatureIcons
          title={features.title}
          subtitle={features.subtitle}
          description={features.description}
          showDescriptionOnHover={true}
          items={features.items}
        />
      </div>
    </div>
  </section>
  <TestimonialScroller />

  <div>
    <FullCta
      title={cta.title}
      image={ctaImage}
      link={cta.link}
      buttonText={cta.buttonText}
    />
  </div>
</Layout>
